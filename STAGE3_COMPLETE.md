# Этап 3: Отзывы и рейтинги - ЗАВЕРШЁН ✅

## Реализованный функционал

### Backend

1. **Модель данных (Prisma Schema)**
   - ✅ Review - полная модель отзывов
   - ✅ ReviewStatus enum (PENDING, APPROVED, REJECTED)
   - ✅ Связи с User (reviewsGiven, reviewsReceived)
   - ✅ Связь с Order
   - ✅ Модерация (moderatedBy, moderationNote, moderatedAt)

2. **Сервис отзывов (review.service.ts)**
   - ✅ Создание отзывов с валидацией
   - ✅ Проверка участия в заказе
   - ✅ Проверка статуса заказа (только COMPLETED)
   - ✅ Запрет дублирования отзывов
   - ✅ Получение отзывов о пользователе
   - ✅ Получение отзывов пользователя
   - ✅ Статистика отзывов с распределением
   - ✅ Модерация (одобрение/отклонение)
   - ✅ Автоматический пересчёт рейтинга
   - ✅ Проверка возможности оставить отзыв

3. **Расчёт рейтингов**
   - ✅ Автоматический пересчёт при одобрении отзыва
   - ✅ Средний рейтинг из одобренных отзывов
   - ✅ Округление до 1 знака после запятой
   - ✅ Начальный рейтинг 3.0 для новых пользователей
   - ✅ Обновление в таблице User

4. **Модерация**
   - ✅ Отзывы по умолчанию на модерации (PENDING)
   - ✅ Только одобренные отзывы видны публично
   - ✅ Модератор может одобрить/отклонить
   - ✅ Причина отклонения (moderationNote)
   - ✅ Запись модератора и времени

5. **API Endpoints**
   - ✅ `POST /api/reviews` - создать отзыв
   - ✅ `GET /api/reviews/user/:userId` - отзывы о пользователе
   - ✅ `GET /api/reviews/user/:userId/stats` - статистика
   - ✅ `GET /api/reviews/my` - мои отзывы
   - ✅ `GET /api/reviews/:id` - отзыв по ID
   - ✅ `GET /api/reviews/order/:orderId/can-leave` - проверка
   - ✅ `GET /api/reviews/pending` - на модерации (админ)
   - ✅ `POST /api/reviews/:id/moderate` - модерация (админ)

6. **Валидация (Joi)**
   - ✅ Рейтинг от 1 до 5
   - ✅ Комментарий минимум 10 символов
   - ✅ Комментарий максимум 1000 символов
   - ✅ Валидация действия модератора

### Frontend

1. **Типы и API клиент**
   - ✅ TypeScript типы для Review, ReviewStats
   - ✅ API клиент для всех операций с отзывами

2. **Компоненты**
   - ✅ `ReviewCard` - карточка отзыва
     - Аватар пользователя
     - Звёзды рейтинга
     - Текст отзыва
     - Дата
     - Статус модерации
   - ✅ `ReviewStats` - статистика отзывов
     - Средний рейтинг
     - Общее количество
     - Распределение по звёздам
     - Прогресс-бары
   - ✅ `CreateReviewForm` - форма создания отзыва
     - Интерактивные звёзды
     - Поле комментария
     - Валидация
     - Счётчик символов

3. **Страницы**
   - ✅ `/orders/[id]/review` - создание отзыва
     - Проверка возможности
     - Автоматическое определение reviewee
     - Отправка на модерацию
   - ✅ `/profile/[userId]/reviews` - просмотр отзывов
     - Список отзывов
     - Статистика
     - Фильтрация одобренных

4. **Интеграция**
   - ✅ Кнопка "Оставить отзыв" на странице заказа
   - ✅ Показывается только для завершённых заказов
   - ✅ Только для участников заказа

### Бизнес-логика

1. **Правила создания отзывов**
   - ✅ Только на завершённые заказы (COMPLETED)
   - ✅ Только участники заказа
   - ✅ Один отзыв на заказ от пользователя
   - ✅ Заказчик оценивает исполнителя
   - ✅ Исполнитель оценивает заказчика

2. **Модерация**
   - ✅ Все отзывы сначала PENDING
   - ✅ Публично видны только APPROVED
   - ✅ При одобрении пересчитывается рейтинг
   - ✅ При отклонении указывается причина

3. **Рейтинги**
   - ✅ Начальный рейтинг 3.0
   - ✅ Обновляется только при одобрении отзыва
   - ✅ Средний из всех одобренных отзывов
   - ✅ Отображается в профиле

### Тестирование

- ✅ Тесты создания отзывов
- ✅ Тесты валидации
- ✅ Тесты дублирования
- ✅ Тесты получения отзывов
- ✅ Тесты статистики
- ✅ Тесты проверки возможности

## Запуск и проверка

### 1. Применить миграции

```bash
cd backend
npx prisma generate
npx prisma migrate dev --name add_reviews
```

### 2. Запустить тесты

```bash
./test-system.sh
```

Или отдельно:

```bash
cd backend
npm test -- review.test.ts
```

### 3. Проверить функционал

**Сценарий 1: Заказчик оставляет отзыв**
1. Завершите заказ (статус COMPLETED)
2. На странице заказа нажмите "Оставить отзыв"
3. Поставьте оценку (1-5 звёзд)
4. Напишите комментарий (минимум 10 символов)
5. Отправьте отзыв (статус PENDING)

**Сценарий 2: Исполнитель оставляет отзыв**
1. Завершите заказ как исполнитель
2. На странице заказа нажмите "Оставить отзыв"
3. Оцените заказчика
4. Опишите опыт сотрудничества
5. Отправьте отзыв

**Сценарий 3: Просмотр отзывов**
1. Перейдите в профиль пользователя
2. Нажмите на рейтинг или "Отзывы"
3. Просмотрите все одобренные отзывы
4. Изучите статистику

## API Примеры

### Создать отзыв

```bash
POST /api/reviews
Authorization: Bearer <token>
Content-Type: application/json

{
  "orderId": "uuid",
  "rating": 5,
  "comment": "Отличная работа! Всё сделано качественно и в срок."
}
```

### Получить отзывы о пользователе

```bash
GET /api/reviews/user/:userId
```

### Получить статистику

```bash
GET /api/reviews/user/:userId/stats
```

Ответ:
```json
{
  "stats": {
    "total": 15,
    "averageRating": 4.7,
    "distribution": {
      "5": 10,
      "4": 3,
      "3": 2,
      "2": 0,
      "1": 0
    }
  }
}
```

### Модерация (админ)

```bash
POST /api/reviews/:id/moderate
Authorization: Bearer <admin-token>
Content-Type: application/json

{
  "action": "approve"
}
```

или

```json
{
  "action": "reject",
  "note": "Нецензурная лексика"
}
```

## Статистика

### Backend
- **Файлов:** 4
  - review.service.ts (500+ строк)
  - review.controller.ts
  - review.routes.ts
  - review.validation.ts
- **API endpoints:** 8
- **Тестов:** 15+

### Frontend
- **Компонентов:** 3
- **Страниц:** 2
- **API клиент:** 1

### База данных
- **Новых моделей:** 1 (Review)
- **Enums:** 1 (ReviewStatus)
- **Связей:** 3

## Соответствие ТЗ

Согласно ТЗ (tz.txt):

✅ **Отзывы заказчиков о исполнителях:**
- Текстовый отзыв ✅
- Оценка по пятибалльной шкале ✅
- Влияние на рейтинг ✅
- Возможность просмотра ✅

✅ **Отзывы исполнителей о заказчиках:**
- Оценка заказчика ✅
- Комментарий ✅
- Формирование рейтинга заказчика ✅

✅ **Формирование рейтинга:**
- Начальный рейтинг 3.0 ✅
- Пересчёт на основании оценок ✅
- Среднее арифметическое ✅
- Отображение в профиле ✅

✅ **Модерация отзывов:**
- Проверка на корректность ✅
- Удаление некорректных ✅
- Прозрачность ✅

## Примечания

- Отзывы по умолчанию невидимы до модерации
- Рейтинг пересчитывается автоматически
- Только одобренные отзывы влияют на рейтинг
- Дублирование отзывов на заказ запрещено
- Отзывы можно оставлять только на завершённые заказы

## Следующие этапы

### Этап 4: Монетизация
- Интеграция ЮKassa
- Пополнение баланса
- Управление подписками
- История транзакций

### Этап 5: Админ-панель
- Модерация отзывов через UI
- Модерация пользователей
- Аналитика и отчёты

---

**Этап 3 полностью завершён!** ✨

Система отзывов и рейтингов работает полностью согласно ТЗ, обеспечивая доверие между пользователями платформы.

