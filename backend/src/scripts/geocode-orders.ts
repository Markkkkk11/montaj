/**
 * –°–∫—Ä–∏–ø—Ç –¥–ª—è –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–∫–∞–∑–æ–≤
 */
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

// –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≥–æ—Ä–æ–¥–æ–≤ –†–æ—Å—Å–∏–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
const DEFAULT_CITY_COORDS: Record<string, { lat: number; lon: number }> = {
  '–ú–æ—Å–∫–≤–∞': { lat: 55.7558, lon: 37.6173 },
  '–ú–æ—Å–∫–≤–∞ –∏ –æ–±–ª.': { lat: 55.7558, lon: 37.6173 },
  '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥': { lat: 59.9343, lon: 30.3351 },
  '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥ –∏ –æ–±–ª.': { lat: 59.9343, lon: 30.3351 },
  '–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä': { lat: 45.0355, lon: 38.9753 },
  '–ù–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫': { lat: 55.0084, lon: 82.9357 },
  '–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥': { lat: 56.8389, lon: 60.6057 },
  '–ö–∞–∑–∞–Ω—å': { lat: 55.8304, lon: 49.0661 },
  '–ù–∏–∂–Ω–∏–π –ù–æ–≤–≥–æ—Ä–æ–¥': { lat: 56.2965, lon: 43.9361 },
  '–ß–µ–ª—è–±–∏–Ω—Å–∫': { lat: 55.1644, lon: 61.4368 },
  '–°–∞–º–∞—Ä–∞': { lat: 53.1959, lon: 50.1002 },
  '–û–º—Å–∫': { lat: 54.9885, lon: 73.3242 },
  '–†–æ—Å—Ç–æ–≤-–Ω–∞-–î–æ–Ω—É': { lat: 47.2357, lon: 39.7015 },
};

async function geocodeOrders() {
  try {
    // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –∑–∞–∫–∞–∑—ã –±–µ–∑ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
    const ordersWithoutCoords = await prisma.order.findMany({
      where: {
        OR: [
          { latitude: null },
          { longitude: null },
        ],
      },
    });

    console.log(`üìç –ù–∞–π–¥–µ–Ω–æ –∑–∞–∫–∞–∑–æ–≤ –±–µ–∑ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç: ${ordersWithoutCoords.length}`);

    let updated = 0;
    let skipped = 0;
    
    for (const order of ordersWithoutCoords) {
      // –ù–ï —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ü–µ–Ω—Ç—Ä–∞ –≥–æ—Ä–æ–¥–∞
      // –û—Å—Ç–∞–≤–ª—è–µ–º null, –µ—Å–ª–∏ —Ç–æ—á–Ω—ã–π –∞–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω
      console.log(`‚ö†Ô∏è  –ü—Ä–æ–ø—É—â–µ–Ω –∑–∞–∫–∞–∑ ${order.id}: –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –¥–ª—è "${order.address}, ${order.region}"`);
      console.log(`   –ó–∞–∫–∞–∑ –±—É–¥–µ—Ç —Å–∫—Ä—ã—Ç –Ω–∞ –∫–∞—Ä—Ç–µ –¥–æ —É—Ç–æ—á–Ω–µ–Ω–∏—è –∞–¥—Ä–µ—Å–∞`);
      skipped++;
    }

    console.log(`\nüìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:`);
    console.log(`   ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ –∑–∞–∫–∞–∑–æ–≤: ${updated}`);
    console.log(`   ‚è≠Ô∏è  –ü—Ä–æ–ø—É—â–µ–Ω–æ –∑–∞–∫–∞–∑–æ–≤: ${skipped}`);
    console.log(`\nüí° –°–æ–≤–µ—Ç: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–æ–≤ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞`);
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è:', error);
  } finally {
    await prisma.$disconnect();
  }
}

geocodeOrders();

