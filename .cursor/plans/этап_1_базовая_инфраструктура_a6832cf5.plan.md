---
name: "Этап 1: Базовая инфраструктура"
overview: "Создание фундамента проекта: настройка монорепозитория, базы данных, базовый API и frontend с системой аутентификации. После этого этапа у нас будет работающая регистрация и личные кабинеты."
todos:
  - id: setup_project
    content: Инициализация монорепозитория с backend и frontend
    status: pending
  - id: docker_setup
    content: Настройка Docker Compose с PostgreSQL и Redis
    status: pending
    dependencies:
      - setup_project
  - id: prisma_schema
    content: Создание Prisma schema с моделями User, ExecutorProfile, SMSVerification
    status: pending
    dependencies:
      - docker_setup
  - id: backend_base
    content: Базовый Express сервер с middleware (auth, validation, error)
    status: pending
    dependencies:
      - prisma_schema
  - id: sms_service
    content: SMS сервис с интеграцией SMSC.ru для верификации
    status: pending
    dependencies:
      - backend_base
  - id: auth_api
    content: "API аутентификации: регистрация, SMS-верификация, логин, JWT"
    status: pending
    dependencies:
      - sms_service
  - id: user_api
    content: "API профилей: получение, обновление, загрузка фото"
    status: pending
    dependencies:
      - auth_api
  - id: frontend_setup
    content: Next.js 14 проект с Tailwind CSS и Shadcn/ui
    status: pending
    dependencies:
      - setup_project
  - id: auth_pages
    content: Страницы регистрации и логина с SMS-верификацией
    status: pending
    dependencies:
      - frontend_setup
      - auth_api
  - id: profile_pages
    content: Страницы профилей (общий + для исполнителей)
    status: pending
    dependencies:
      - auth_pages
      - user_api
  - id: dashboards
    content: Базовые dashboard'ы для заказчика и исполнителя
    status: pending
    dependencies:
      - profile_pages
  - id: testing_stage1
    content: Тестирование регистрации, авторизации и профилей
    status: pending
    dependencies:
      - dashboards
---

# Этап 1: Базовая инфраструктура и аутентификация

## Цель этапа

Создать минимально работающую платформу с регистрацией, авторизацией и базовыми профилями пользователей.

## Что будет работать после этапа

- ✅ Регистрация заказчиков и исполнителей
- ✅ SMS-верификация телефонов
- ✅ Авторизация (JWT токены)
- ✅ Личные кабинеты с базовой информацией
- ✅ Редактирование профилей
- ✅ Загрузка фото профиля

## Структура проекта

```javascript
montaj/
├── backend/
│   ├── src/
│   │   ├── config/
│   │   │   ├── database.ts
│   │   │   ├── redis.ts
│   │   │   └── env.ts
│   │   ├── middleware/
│   │   │   ├── auth.middleware.ts
│   │   │   ├── validation.middleware.ts
│   │   │   └── error.middleware.ts
│   │   ├── controllers/
│   │   │   ├── auth.controller.ts
│   │   │   └── user.controller.ts
│   │   ├── services/
│   │   │   ├── auth.service.ts
│   │   │   ├── sms.service.ts
│   │   │   └── user.service.ts
│   │   ├── routes/
│   │   │   ├── auth.routes.ts
│   │   │   └── user.routes.ts
│   │   ├── utils/
│   │   │   ├── jwt.ts
│   │   │   └── hash.ts
│   │   ├── types/
│   │   │   └── index.ts
│   │   └── app.ts
│   ├── prisma/
│   │   └── schema.prisma
│   ├── package.json
│   ├── tsconfig.json
│   └── .env.example
├── frontend/
│   ├── src/
│   │   ├── app/
│   │   │   ├── (auth)/
│   │   │   │   ├── login/page.tsx
│   │   │   │   └── register/page.tsx
│   │   │   ├── (customer)/
│   │   │   │   └── dashboard/page.tsx
│   │   │   ├── (executor)/
│   │   │   │   └── dashboard/page.tsx
│   │   │   ├── profile/page.tsx
│   │   │   └── layout.tsx
│   │   ├── components/
│   │   │   ├── ui/ (shadcn)
│   │   │   ├── auth/
│   │   │   │   ├── RegisterForm.tsx
│   │   │   │   ├── LoginForm.tsx
│   │   │   │   └── SMSVerification.tsx
│   │   │   ├── profile/
│   │   │   │   ├── ProfileForm.tsx
│   │   │   │   └── PhotoUpload.tsx
│   │   │   └── layout/
│   │   │       ├── Header.tsx
│   │   │       └── Footer.tsx
│   │   ├── lib/
│   │   │   ├── api.ts
│   │   │   └── auth.ts
│   │   ├── hooks/
│   │   │   └── useAuth.ts
│   │   └── stores/
│   │       └── authStore.ts
│   ├── package.json
│   └── next.config.js
├── docker-compose.yml
├── .env.example
└── README.md
```



## База данных (Prisma Schema)

Для этого этапа нужны минимальные модели:

```prisma
model User {
  id                String    @id @default(uuid())
  role              Role
  phone             String    @unique
  email             String?
  password          String
  fullName          String
  organization      String?
  city              String
  address           String?
  messengers        Json?
  photo             String?
  rating            Float     @default(3.0)
  completedOrders   Int       @default(0)
  status            UserStatus @default(PENDING)
  isPhoneVerified   Boolean   @default(false)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  executorProfile   ExecutorProfile?
  
  @@index([phone])
  @@index([status])
}

model ExecutorProfile {
  id                  String   @id @default(uuid())
  userId              String   @unique
  user                User     @relation(fields: [userId], references: [id])
  
  region              String
  specializations     String[]
  shortDescription    String?
  fullDescription     String?
  workPhotos          String[]
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

model SMSVerification {
  id          String   @id @default(uuid())
  phone       String
  code        String
  expiresAt   DateTime
  verified    Boolean  @default(false)
  createdAt   DateTime @default(now())
  
  @@index([phone, code])
}

enum Role {
  CUSTOMER
  EXECUTOR
}

enum UserStatus {
  PENDING
  ACTIVE
  REJECTED
  BLOCKED
}
```



## Backend API Endpoints

### Аутентификация

- `POST /api/auth/register` - Регистрация (с выбором роли)
- `POST /api/auth/send-sms` - Отправка SMS-кода
- `POST /api/auth/verify-sms` - Проверка SMS-кода
- `POST /api/auth/login` - Вход
- `POST /api/auth/logout` - Выход
- `GET /api/auth/me` - Получить текущего пользователя

### Профили

- `GET /api/users/profile` - Получить свой профиль
- `PUT /api/users/profile` - Обновить профиль
- `POST /api/users/upload-photo` - Загрузить фото

## Frontend Pages

### Публичные страницы

1. **Главная страница** (`/`)

- Описание сервиса
- Кнопки "Войти" / "Зарегистрироваться"

2. **Регистрация** (`/register`)

- Выбор роли (Заказчик / Исполнитель)
- Форма регистрации
- SMS-верификация
- Согласие с правилами

3. **Вход** (`/login`)

- Форма входа (телефон + пароль)

### Защищенные страницы

4. **Профиль** (`/profile`)

- Просмотр и редактирование профиля
- Для исполнителя: дополнительные поля (специализации, описание, фото работ)

5. **Dashboard заказчика** (`/customer/dashboard`)

- Заглушка "Мои заказы" (будет в следующем этапе)

6. **Dashboard исполнителя** (`/executor/dashboard`)

- Заглушка "Доступные заказы" (будет в следующем этапе)

## Docker Compose Setup

```yaml
version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: montaj
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
    - "5432:5432"
    volumes:
    - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    ports:
    - "6379:6379"
    volumes:
    - redis_data:/data

  backend:
    build: ./backend
    ports:
    - "3001:3001"
    environment:
      DATABASE_URL: postgresql://postgres:postgres@postgres:5432/montaj
      REDIS_URL: redis://redis:6379
      JWT_SECRET: your-secret-key
      SMSC_LOGIN: your-login
      SMSC_PASSWORD: your-password
    depends_on:
    - postgres
    - redis
    volumes:
    - ./backend:/app
    - /app/node_modules

  frontend:
    build: ./frontend
    ports:
    - "3000:3000"
    environment:
      NEXT_PUBLIC_API_URL: http://localhost:3001
    depends_on:
    - backend
    volumes:
    - ./frontend:/app
    - /app/node_modules

volumes:
  postgres_data:
  redis_data:
```



## Ключевые технические детали

### SMS-верификация (SMSC.ru)

```typescript
// backend/src/services/sms.service.ts
async sendVerificationCode(phone: string): Promise<void> {
  const code = Math.floor(100000 + Math.random() * 900000).toString();
  const expiresAt = new Date(Date.now() + 5 * 60 * 1000); // 5 минут
  
  // Сохраняем в БД
  await prisma.sMSVerification.create({
    data: { phone, code, expiresAt }
  });
  
  // Отправляем через SMSC.ru
  const response = await fetch('https://smsc.ru/sys/send.php', {
    method: 'POST',
    body: new URLSearchParams({
      login: process.env.SMSC_LOGIN,
      psw: process.env.SMSC_PASSWORD,
      phones: phone,
      mes: `Ваш код подтверждения: ${code}`
    })
  });
}
```



### JWT Authentication

```typescript
// backend/src/middleware/auth.middleware.ts
export const authenticate = async (req, res, next) => {
  const token = req.headers.authorization?.split(' ')[1];
  
  if (!token) {
    return res.status(401).json({ error: 'Unauthorized' });
  }
  
  try {
    const payload = jwt.verify(token, process.env.JWT_SECRET);
    req.user = await prisma.user.findUnique({ 
      where: { id: payload.userId } 
    });
    next();
  } catch (error) {
    return res.status(401).json({ error: 'Invalid token' });
  }
};
```



### Frontend Auth State (Zustand)

```typescript
// frontend/src/stores/authStore.ts
interface AuthState {
  user: User | null;
  token: string | null;
  login: (phone: string, password: string) => Promise<void>;
  logout: () => void;
  updateProfile: (data: Partial<User>) => Promise<void>;
}

export const useAuthStore = create<AuthState>((set) => ({
  user: null,
  token: null,
  login: async (phone, password) => {
    const response = await api.post('/auth/login', { phone, password });
    set({ user: response.data.user, token: response.data.token });
    localStorage.setItem('token', response.data.token);
  },
  logout: () => {
    set({ user: null, token: null });
    localStorage.removeItem('token');
  },
  updateProfile: async (data) => {
    const response = await api.put('/users/profile', data);
    set({ user: response.data });
  }
}));
```



## Что НЕ входит в этот этап

❌ Система заказов❌ Отклики❌ Баланс и платежи❌ Карты❌ Отзывы и рейтинги❌ Модерация (базовая проверка будет, но без админ-панели)❌ Уведомления (кроме SMS для верификации)

## План следующих этапов

**Этап 2: Система заказов**

- Создание заказов заказчиками
- Лента заказов
- Фильтры и поиск
- Карта с Яндекс.Картами

**Этап 3: Система откликов и тарификация**

- Баланс исполнителей
- Три тарифа
- Отклики на заказы
- Выбор исполнителя
- ЮKassa интеграция

**Этап 4: Выполнение работ и отзывы**

- Workflow заказов
- Статусы
- Система отзывов
- Рейтинги

**Этап 5: Админ-панель**

- Модерация
- Управление пользователями
- Аналитика
- Настройки

## Оценка времени Этапа 1: 5-7 дней

## Готовы начать?

После завершения этого этапа у нас будет:

1. Работающая регистрация с SMS
2. Личные кабинеты
3. Редактирование профилей